@startuml Contract_Relationship_Diagram_Updated
' ====================
' 基础设置
' ====================
allowmixing

skinparam BackgroundColor #F5F5F5
skinparam shadowing true
skinparam dpi 500
skinparam ArrowThickness 5
skinparam defaultFontSize 26
skinparam classFontSize 28
skinparam actorFontSize 28

' 类颜色定义
!define CORE_COLOR     #ed98ebff
!define FACTORY_COLOR  #9af39dff
!define BUSINESS_COLOR #eda386ff
!define RECORD_COLOR   #a3d8f4ff

skinparam class {
    BackgroundColor<<Core>>     CORE_COLOR
    BackgroundColor<<Factory>>  FACTORY_COLOR
    BackgroundColor<<Business>> BUSINESS_COLOR
    BackgroundColor<<Record>>   RECORD_COLOR
    BorderColor #455A64
    ArrowColor #1976D2
    FontSize 40
    FontName Arial
}

skinparam note {
    BackgroundColor #FFECB3
    BorderColor #F57C00
}

skinparam package {
    BackgroundColor #FFFFFF
    BorderColor #78909C
    FontSize 32
}

' ====================
' 核心合约层
' ====================
package "基础设施层" {
    class User <<Core>> {
        + UserRole           ' enum: Admin, Technician, Farmer, Guest
        + users              ' mapping (address => UserInfo)
        + isAdmin            ' mapping (address => bool)
        --
        + registerUser()
        + updateUserRole()
        + getUserRole()
        + userExists()
    }
}

note right of User
角色定义:
Admin - 管理员
Technician - 技术员
Farmer - 果农
Guest - 访客
end note

' ====================
' 工厂层
' ====================
package "对象工厂层" {
    class DroneObjectFactory <<Factory>> {
        + DroneType          ' enum: Scout, Marker, Other
        + DroneState         ' enum: Used, Free, Maintenance
        + drones             ' mapping (address => Drone)
        + userContract
        --
        + registerDrone()
        + updateDroneState()
        + updateFirmwareVersion()
        + addMaintenanceLog()
        + getDroneType()
        + droneExists()
    }

    class GridObjectFactory <<Factory>> {
        + GridStatus
        + CitrusDiseaseType
        + grids              ' mapping (address => GridInfo)
        + authorizedCallers  ' mapping (address => bool)
        + userContract
        + droneFactory
        --
        + authorizeCaller()
        + registerGrid()
        + updateGridStatus()
        + updateDiseaseType()
        + addMaintenanceRecord()
    }
}

' ====================
' 业务编排层
' ====================
package "业务编排 & 记录层" {
    class FarmFactory <<Business>> {
        + farms
        + farmGridCodeToId
        + farmGridList
        + gridFactory
        + userContract
        + droneFactory
        + recordManager      ' FarmRecordManager 地址
        --
        + createFarm()
        + addGridToFarm()
        + updateGridStatus()
        + updateGridDiseaseType()
        + setRecordManager() ' 仅管理员可调用一次
        + updateGridStatusFromRecord()    ' 回调接口
        + updateGridDiseaseTypeFromRecord() ' 回调接口
    }

    class FarmRecordManager <<Record>> {
        + riskDetections
        + markingOperations
        + removals
        + replantings
        + farmFactory        ' IFarmFactory 接口
        + userContract
        + droneFactory
        --
        + addRiskDetection()        ' Scout Drone
        + addMarkingOperation()     ' Marker Drone
        + addTreeRemoval()          ' Farmer
        + addReplanting()           ' Farmer
        + getRecentRiskDetections()
        + getRecentMarkingOperations()
        + getRecordCounts()
    }
}

' ====================
' 依赖关系（实线）
' ====================
DroneObjectFactory --> User : 依赖
GridObjectFactory --> User : 依赖
GridObjectFactory --> DroneObjectFactory : 依赖

FarmFactory --> User : 依赖
FarmFactory --> DroneObjectFactory : 依赖
FarmFactory --> GridObjectFactory : 委托调用
FarmFactory --> FarmRecordManager : 持有地址 + 回调

FarmRecordManager --> FarmFactory : 回调更新状态
FarmRecordManager --> User : 权限检查
FarmRecordManager --> DroneObjectFactory : 验证无人机类型

' ====================
' 角色与交互（虚线）
' ====================
actor "Admin" as Admin
actor "Technician" as Technician
actor "Farmer" as Farmer
actor "Scout Drone" as ScoutDrone
actor "Marker Drone" as MarkerDrone

Admin       ..> User               : 管理用户 & 授权
Technician  ..> DroneObjectFactory : 注册/维护无人机
Farmer      ..> FarmFactory        : 创建农场、添加网格
Farmer      ..> FarmRecordManager  : 病树移除、补种
ScoutDrone  ..> FarmRecordManager  : 风险检测上报
MarkerDrone ..> FarmRecordManager  : 标记操作上报

' ====================
' 部署与授权流程
' ====================
note right of User
部署顺序（严格推荐）:
1. User
2. DroneObjectFactory (传入 User)
3. GridObjectFactory (传入 User + DroneFactory)
4. FarmFactory (传入 GridFactory + User + DroneFactory)
5. FarmRecordManager (传入 FarmFactory + User + DroneFactory)
6. FarmFactory.setRecordManager(RecordManager地址)   ← 必须执行
7. GridFactory.authorizeCaller(FarmFactory地址)      ← 必须执行
end note

' ====================
' 核心业务数据流
' ====================
note left of FarmRecordManager
核心业务流（当前版本）:
1. ScoutDrone → addRiskDetection() → 回调 FarmFactory → Grid.updateStatus()
2. MarkerDrone → addMarkingOperation() → 回调 FarmFactory → Grid.updateStatus()
3. Farmer → addTreeRemoval() → 回调 FarmFactory → Grid.updateStatus() & updateDiseaseType()
4. Farmer → addReplanting() → 回调 FarmFactory → Grid.updateStatus()
end note

' ====================
' 核心优化亮点
' ====================
note right of FarmRecordManager
当前设计亮点:
• 业务记录与状态更新分离，更清晰
• 记录合约只写不读状态，降低耦合
• 回调机制确保原子性
• 无人机权限通过类型 + 存在性校验
end note

@enduml