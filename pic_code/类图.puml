@startuml CitrusHLB_Traceability_DataModel_v1

hide methods
hide stereotype
skinparam linetype curved
skinparam backgroundColor #F8FAF5
skinparam shadowing false
skinparam dpi 160

skinparam class {
    FontSize 26
    FontStyle bold
    BackgroundColor #FFFFFF
    BorderColor #1E88E5
    BorderThickness 3
    RoundCorner 14
}

skinparam note {
    FontSize 20
    BackgroundColor #FFF8E1
    BorderColor #FFB300
    BorderThickness 3
    RoundCorner 14
}

' ================== 核心空间实体 ==================
class Grid {
    +gridCode : string
    gpsCenter : bytes32
}

class HarvestBatch {
    +batchId : uint32
    batchCode : string
    harvestDate : uint32
    totalWeight : uint32
}

class Product {
    +productId : uint32
    qrCodeUrl : string
}

' ================== 风险与作业事件 ==================
class RiskZoneDetectionRecord {
    +recordId : uint32
    timestamp : uint32
    riskLevel : uint8
    ndviValue : uint16
    psyllidDensity : uint8
    evidenceImageIPFS : string
}

class MarkingOperationLog {
    +operationId : uint32
    timestamp : uint32
    markingPointCount : uint8
    markerType : string
}

class DiseaseTreeRemovalRecord {
    +removalId : uint32
    timestamp : uint32
    confirmedDiseaseCount : uint8
    falsePositiveCount : uint8
}

class ReplantingRecord {
    +replantId : uint32
    timestamp : uint32
    seedlingCount : uint8
    seedlingSource : string
}

class GridMaintenanceLog {
    +logId : uint32
    timestamp : uint32
    operationType : string
    operationDetail : string
}

' ================== 物流与追踪 ==================
class LogisticsTrackingRecord {
    +trackingId : uint32
    timestamp : uint32
    nodeType : string
    temperature : int8
    humidity : uint8
}

' ================== 系统级事件 ==================
class EmergencyAlertRecord {
    +alertId : uint32
    timestamp : uint32
    alertLevel : uint8
    affectedGrids : string
}

class DroneMaintenanceLog {
    +logId : uint32
    timestamp : uint32
    droneType : string
    maintenanceType : string
}

' ================== 关系定义 ==================

Grid "1" <-- "many" RiskZoneDetectionRecord : 发生于
RiskZoneDetectionRecord "1" --> "many" MarkingOperationLog : 触发
MarkingOperationLog "1" --> "many" DiseaseTreeRemovalRecord : 导致
DiseaseTreeRemovalRecord "1" --> "many" ReplantingRecord : 补种

Grid "1" <-- "many" GridMaintenanceLog : 养护记录
Grid "1" --> "many" HarvestBatch : 采摘来源
HarvestBatch "1" --> "many" LogisticsTrackingRecord : 冷链追踪
HarvestBatch "1" --> "many" Product : 封装为

RiskZoneDetectionRecord "many" --> "1" EmergencyAlertRecord : 聚合分析

DroneMaintenanceLog ..> RiskZoneDetectionRecord : 数据可信性保障
DroneMaintenanceLog ..> MarkingOperationLog

note right of Grid
<b>Grid 是所有溯源的空间锚点</b>
所有事件最终都可以
回溯到一个网格
end note

note right of HarvestBatch
<b>HarvestBatch 是商品化边界</b>
农业事件 → 商品事件
end note

note right of EmergencyAlertRecord
<b>跨网格系统事件</b>
不是单点操作
end note

@enduml
