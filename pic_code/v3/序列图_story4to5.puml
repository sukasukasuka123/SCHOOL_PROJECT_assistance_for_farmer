@startuml Sequence_Story4to5_ReplantingAndMaintenance
!define PRIMARY #1565C0
!define SECONDARY #2E7D32
!define ACCENT #F57C00

hide footbox
skinparam backgroundColor #FAFAFA
skinparam dpi 180
skinparam shadowing false

skinparam sequence {
    ArrowColor SECONDARY
    ArrowThickness 2
    LifeLineBorderColor #455A64
    LifeLineBackgroundColor #FFFFFF
    ParticipantBorderThickness 3
    ParticipantFontSize 18
    ParticipantFontStyle bold
    MessageFontSize 16
}

skinparam box {
    BackgroundColor #E8F5E9
    BorderColor SECONDARY
    BorderThickness 2
}

title <size:24><b>故事4-5: 科学补种与季节养护</b></size>\n<size:16>脱毒苗补种 → 全年作业存证</size>

actor "果农老李\nFarmer" as Farmer #F57C00
participant "合作社\n苗圃系统" as Nursery #4CAF50
box "云端协同层" #E3F2FD
    participant "网格引擎\nGridLifecycle" as GridEngine #2E7D32
    participant "网关\nGateway" as Gateway #2E7D32
end box
participant "区块链\nBlockchain" as BC #6A1B9A
participant "IPFS" as IPFS #6A1B9A
participant "生物防治技术员" as BioTech #8BC34A

== 故事4: 科学补种 (病株移除后15天) ==
note over Farmer
<b>收到推送</b>
"B3网格适宜补种"
原病株向北偏移1.5m
end note

Farmer -> Nursery : 申请购买脱毒苗\n品种: 砂糖桔\n数量: 2株

activate Nursery
Nursery -> Nursery : 验证检疫证明\n确认脱毒批次
Nursery --> Farmer : 交付苗木\n附带二维码 + 检疫证明
deactivate Nursery

Farmer -> Farmer : 扫描苗木二维码\n读取来源信息
note right
<b>苗木二维码信息</b>
来源: XX合作社脱毒苗圃
批次: DT-2025-0312
检疫证明: QC-GD-20250310
品种: 砂糖桔-脱毒苗
end note

Farmer -> Farmer : <b>按推荐位置补种</b>\n点1: 原病株北偏1.5m\n点2: 原病株北偏1.5m\n避开残留病原

Farmer -> Farmer : 拍照上传\n补种现场 + 苗木特写

Farmer -> Gateway : 提交 ReplantingRecord
activate Gateway
note right
<b>数据结构</b>
replantId: 40001
linkedRemovalId: 30001
gridCode: "B3"
seedlingCount: 2
seedlingSource: "XX合作社"
quarantineCertHash: "0xQC..."
seedlingVariety: "砂糖桔-脱毒苗"
end note

Gateway -> IPFS : 存储补种现场照片
IPFS --> Gateway : 返回 IPFS Hash

Gateway -> BC : 上链补种事件
BC --> Gateway : 返回交易哈希

Gateway -> GridEngine : 更新 B3 状态
activate GridEngine
GridEngine -> GridEngine : 状态: 待补种 → 恢复中\n创建新树档案
GridEngine --> Farmer : 推送成功\n"补种完成,已建立新树档案"
deactivate Gateway

== 故事5: 季节养护 (3月-11月) ==
note over GridEngine
<b>B3网格全年作业计划</b>
3-11月: 8个月生长周期
目标: 黄龙病零感染
end note

loop 3月-11月 (8个月周期)
    
    alt 侦察机巡检 (每2周)
        GridEngine -> GridEngine : 定期巡检任务\n检测木虱风险
        note right : 共15次巡检\n发现4次木虱风险
    end
    
    alt 生物防治 (每月1次)
        GridEngine -> BioTech : 触发生物防治任务\nB3网格需释放捕食螨
        activate BioTech
        BioTech -> BioTech : 释放捕食螨\n500只/次\n天敌防控木虱
        
        BioTech -> BioTech : 拍照记录\n释放位置 + 数量
        
        BioTech -> Gateway : 提交 GridMaintenanceLog
        activate Gateway
        note right
        <b>数据结构</b>
        logId: 50001-50008
        gridCode: "B3"
        operationType: "生物防治"
        operationDetail: "释放捕食螨500只"
        operatorAddress: 0xBioTech456
        end note
        
        Gateway -> IPFS : 存储作业照片
        IPFS --> Gateway : 返回 IPFS Hash
        
        Gateway -> BC : 上链养护事件
        BC --> Gateway : 返回交易哈希
        
        Gateway -> GridEngine : 累计养护记录
        GridEngine -> GridEngine : B3网格档案 +1\n总计: 生物防治 × N
        deactivate Gateway
        deactivate BioTech
    end
    
    alt 人工施肥 (按需)
        Farmer -> Farmer : 观察树势\n补充有机肥
        Farmer -> Gateway : 提交养护记录
        activate Gateway
        Gateway -> IPFS : 存储作业证据
        Gateway -> BC : 上链事件
        Gateway -> GridEngine : 更新档案
        deactivate Gateway
    end
    
    alt 修剪整形 (春季/秋季)
        Farmer -> Farmer : 修剪病弱枝\n改善通风透光
        Farmer -> Gateway : 提交养护记录
        activate Gateway
        Gateway -> IPFS : 存储修剪照片
        Gateway -> BC : 上链事件
        Gateway -> GridEngine : 更新档案
        deactivate Gateway
    end
    
end

GridEngine -> GridEngine : <b>生成B3网格年度档案</b>
note right
<b>3月-11月统计</b>
✓ 巡检: 15次 (4次风险预警)
✓ 标记作业: 4次
✓ 病株移除: 2次
✓ 补种: 1次 (2株)
✓ 生物防治: 8次
✓ 化学防治: 0次
✓ 人工施肥: 若干次
✓ 修剪整形: 若干次
--
<b>区块链记录总数: 30+</b>
end note

GridEngine --> Farmer : 推送年度报告\n"B3网格养护档案已生成"

@enduml
