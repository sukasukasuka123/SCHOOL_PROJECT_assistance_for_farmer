@startuml Story6_HarvestAndBatching
!define PRIMARY #1565C0
!define ACCENT #F57C00
!define INFO #6A1B9A

hide footbox
skinparam backgroundColor #FAFAFA
skinparam dpi 500
skinparam shadowing false

skinparam sequence {
    ArrowColor ACCENT
    ArrowThickness 2
    LifeLineBorderColor #455A64
    LifeLineBackgroundColor #FFFFFF
    ParticipantBorderThickness 3
    ParticipantFontSize 20
    ParticipantFontStyle bold
    MessageFontSize 18
}

skinparam box {
    BackgroundColor #FFF3E0
    BorderColor ACCENT
    BorderThickness 2
}

skinparam noteFontSize 16

title <size:28><b>故事6: 采摘入库 (12月成熟期)</b></size>\n<size:18>批次封装与全年档案聚合</size>

actor "采摘工人" as Worker #FF9800
participant "PDA设备\n采摘终端" as PDA #F57C00
box "云端协同层" #E8F5E9
    participant "批次封装服务\nBatchService" as BatchService #F57C00
    participant "网关\nGateway" as Gateway #2E7D32
    participant "网格引擎\nGridLifecycle" as GridEngine #2E7D32
end box
participant "区块链\nBlockchain" as BC #6A1B9A
participant "IPFS" as IPFS #6A1B9A

note over Worker
<b>B3网格砂糖桔成熟</b>
果径达标,糖度适宜
开始采摘作业
end note

Worker -> PDA : 扫码开始采摘\n目标网格: B3
activate PDA
PDA -> GridEngine : 查询 B3 网格全年档案
activate GridEngine

GridEngine -> GridEngine : <b>聚合网格数据</b>\n检索所有关联记录
note right
<b>数据聚合范围</b>
• 4条 RiskZoneDetectionRecord
• 4条 MarkingOperationLog
• 2条 DiseaseTreeRemovalRecord
• 1条 ReplantingRecord
• 8条 GridMaintenanceLog (生物防治)
• 若干条其他养护记录
end note

GridEngine --> PDA : 返回完整档案数据
deactivate GridEngine

Worker -> Worker : 采摘作业\n逐筐装箱\n称重记录

Worker -> PDA : 确认采摘完成\n总重量: 500kg

PDA -> BatchService : 请求生成批次
activate BatchService
BatchService -> BatchService : <b>生成唯一批次码</b>\n算法: 网格+日期+流水号\n结果: B3-2025-1215

BatchService -> Gateway : 提交 HarvestBatchRecord
activate Gateway
note right
<b>数据结构</b>
batchId: 60001
batchCode: "B3-2025-1215"
gridCode: "B3"
harvestDate: 2025-12-15
totalWeight: 500
linkedDetectionIds: [10001,10002,10003,10004]
linkedOperationIds: [20001,20002,30001,40001,...]
diseaseRemovalCount: 2
bioControlCount: 8
chemicalControlCount: 0
end note

Gateway -> IPFS : 存储采摘现场照片
IPFS --> Gateway : 返回 IPFS Hash

Gateway -> BC : 上链批次记录
BC --> Gateway : 返回交易哈希

Gateway -> BatchService : 批次创建成功
deactivate Gateway

BatchService --> PDA : 返回批次码 + 二维码\nB3-2025-1215
deactivate BatchService
deactivate PDA

Worker -> Worker : 打印批次标签\n贴在包装箱上

@enduml
