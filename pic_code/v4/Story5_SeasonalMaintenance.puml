@startuml Story5_SeasonalMaintenance
!define PRIMARY #1565C0
!define SECONDARY #2E7D32
!define ACCENT #F57C00

hide footbox
skinparam backgroundColor #FAFAFA
skinparam dpi 350
skinparam shadowing false

skinparam sequence {
    ArrowColor SECONDARY
    ArrowThickness 2
    LifeLineBorderColor #455A64
    LifeLineBackgroundColor #FFFFFF
    ParticipantBorderThickness 3
    ParticipantFontSize 20
    ParticipantFontStyle bold
    MessageFontSize 18
}

skinparam box {
    BackgroundColor #E8F5E9
    BorderColor SECONDARY
    BorderThickness 2
}

skinparam noteFontSize 16

title <size:28><b>故事5: 季节养护 (3月-11月)</b></size>\n<size:18>全年作业存证与档案生成</size>

actor "果农老李\nFarmer" as Farmer #F57C00
box "云端协同层" #E3F2FD
    participant "网格引擎\nGridLifecycle" as GridEngine #2E7D32
    participant "网关\nGateway" as Gateway #2E7D32
end box
participant "区块链\nBlockchain" as BC #6A1B9A
participant "IPFS" as IPFS #6A1B9A
participant "生物防治技术员" as BioTech #8BC34A

note over GridEngine
<b>B3网格全年作业计划</b>
3-11月: 8个月生长周期
目标: 黄龙病零感染
end note

loop 3月-11月 (8个月周期)
    
    alt 侦察机巡检 (每2周)
        GridEngine -> GridEngine : 定期巡检任务\n检测木虱风险
        note right : 共15次巡检\n发现4次木虱风险
    end
    
    alt 生物防治 (每月1次)
        GridEngine -> BioTech : 触发生物防治任务\nB3网格需释放捕食螨
        activate BioTech
        BioTech -> BioTech : 释放捕食螨\n500只/次\n天敌防控木虱
        
        BioTech -> BioTech : 拍照记录\n释放位置 + 数量
        
        BioTech -> Gateway : 提交 GridMaintenanceLog
        activate Gateway
        note right
        <b>数据结构</b>
        logId: 50001-50008
        gridCode: "B3"
        operationType: "生物防治"
        operationDetail: "释放捕食螨500只"
        operatorAddress: 0xBioTech456
        end note
        
        Gateway -> IPFS : 存储作业照片
        IPFS --> Gateway : 返回 IPFS Hash
        
        Gateway -> BC : 上链养护事件
        BC --> Gateway : 返回交易哈希
        
        Gateway -> GridEngine : 累计养护记录
        GridEngine -> GridEngine : B3网格档案 +1\n总计: 生物防治 × N
        deactivate Gateway
        deactivate BioTech
    end
    
    alt 人工施肥 (按需)
        Farmer -> Farmer : 观察树势\n补充有机肥
        Farmer -> Gateway : 提交养护记录
        activate Gateway
        Gateway -> IPFS : 存储作业证据
        Gateway -> BC : 上链事件
        Gateway -> GridEngine : 更新档案
        deactivate Gateway
    end
    
    alt 修剪整形 (春季/秋季)
        Farmer -> Farmer : 修剪病弱枝\n改善通风透光
        Farmer -> Gateway : 提交养护记录
        activate Gateway
        Gateway -> IPFS : 存储修剪照片
        Gateway -> BC : 上链事件
        Gateway -> GridEngine : 更新档案
        deactivate Gateway
    end
    
end

GridEngine -> GridEngine : <b>生成B3网格年度档案</b>
note right
<b>3月-11月统计</b>
✓ 巡检: 15次 (4次风险预警)
✓ 标记作业: 4次
✓ 病株移除: 2次
✓ 补种: 1次 (2株)
✓ 生物防治: 8次
✓ 化学防治: 0次
✓ 人工施肥: 若干次
✓ 修剪整形: 若干次
--
<b>区块链记录总数: 30+</b>
end note

GridEngine --> Farmer : 推送年度报告\n"B3网格养护档案已生成"

@enduml
