@startuml CitrusHLB_Traceability_Architecture_Refined_v2

hide stereotype

top to bottom direction
skinparam linetype curved
skinparam backgroundColor #F8FAF5
skinparam dpi 200
skinparam shadowing false
skinparam nodesep 80
skinparam ranksep 120

' ================== 全局字体加大 ==================
skinparam defaultFontSize 20
skinparam dpi 160

skinparam package {
    FontSize 42
    FontStyle bold
    FontColor #1A237E
}

skinparam rectangle {
    FontSize 30
    FontStyle plain
    RoundCorner 14
    BorderThickness 4
}


skinparam cloud {
    FontSize 46
    FontStyle bold
    BackgroundColor #E8F0FE
    BorderColor #1E88E5
    BorderThickness 6
}

skinparam note {
    FontSize 22
    FontStyle italic
    BackgroundColor #FFF8E1
    BorderColor #FFB300
    BorderThickness 4
    RoundCorner 18
}

' ================== 设备层高辨识配色 ==================
skinparam rectangle<<device>> {
    BackgroundColor #0288D1
    FontColor #FFFFFF
    BorderColor #01579B
    BorderThickness 5.5
}

skinparam rectangle<<cloudservice>> {
    BackgroundColor #F5F7FA
    FontColor #263238
    BorderColor #455A64
    BorderStyle dashed
    BorderThickness 5
}

' ================== 边缘感知与执行层 ==================
package "边缘感知与执行层" #E8F5E9 {

    rectangle "侦察无人机\n多光谱 + 边缘AI" as Scout
    rectangle "标记/隔离无人机\n荧光标记 + 精准施药" as Deploy
    rectangle "人工处置终端\nPDA / 手机App" as FarmerTool

    Scout   --> Deploy     : 风险坐标 + 优先级
    Deploy  --> FarmerTool : 标记点 + 精准位置

    note right of Scout
        <b>感知与初筛</b>
        • 红边多光谱 680/730/800 nm
        • NDVI + 时序异常检测
        • YOLOv5-Nano 木虱识别
        • 粘虫板密度阈值
    end note

    note right of Deploy
        <b>现场干预</b>
        • 可降解荧光标记（UV激发）
        • 单株20ml精准投放
        • 吡虫啉隔离带
        • 支持生物防治
    end note

    note right of FarmerTool
        <b>人工确认</b>
        • UV手电 + GPS
        • 病株移除 / 误判纠正
        • 现场拍照上链
        • 脱毒苗补种 + 二维码
    end note
}

' ================== 云端协同数据层 ==================
cloud "<size:48><b>云端协同数据层</b></size>\n<sub>逻辑汇聚 + 可信存证</sub>" as CloudHub {

    rectangle "异构通信接入网关\nLoRa / 5G / NB-IoT" as Gateway
    rectangle "可信存证区块链\n事件级不可篡改记录" as BC
    rectangle "分布式内容存储\n图像 / 档案（IPFS）" as IPFS

    Gateway --> BC   : 事件哈希 + 时间戳
    Gateway --> IPFS : 图像/档案 + CID

    note left of BC
        <b>链上存证原则</b>
        • 只存事实声明
        • 事件级粒度（单株/单次）
        • 支持Merkle证明
        • 人工否决同样上链
    end note
}

' ================== 用户服务层 ==================
package "用户服务层" #F3E5F5 {

    rectangle "果农/合作社后台\n实时监控 · 预警 · 调度" as AppB
    rectangle "消费者溯源小程序\n扫码查看全生命周期" as AppC
}

' ================== 主要数据流（更粗、更鲜艳） ==================
Scout      -[#005F99,thickness=7]-> Gateway : 风险图像 + 检测结果
Deploy     -[#005F99,thickness=7]-> Gateway : 作业日志 + 施药证据
FarmerTool -[#005F99,thickness=7]-> Gateway : 处置结果 + 现场照片

BC   -[#2A7F62,thickness=7]-> AppB : 链上查询 + 预警推送
BC   -[#2A7F62,thickness=7]-> AppC : 溯源二维码 + 可验证记录
IPFS -[#2A7F62,thickness=7]-> AppC : 高清图像 + 生长档案

@enduml
